name: CI/CD MLOps Portfolio

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_integration:
        description: 'Run full integration tests'
        required: false
        default: 'true'
        type: boolean

# Global permissions for all jobs
permissions:
  actions: read
  contents: read
  security-events: write  # Required for CodeQL/SARIF upload

env:
  PYTHON_VERSION: '3.12'
  MLFLOW_TRACKING_URI: http://localhost:5000

jobs:
  # Job 1: Tests unitarios por proyecto
  tests:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']
        project:
          - BankChurn-Predictor
          - CarVision-Market-Intelligence
          - TelecomAI-Customer-Intelligence
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_DB: mlflow
          POSTGRES_USER: mlflow
          POSTGRES_PASSWORD: mlflow_test
        options: >-
          --health-cmd "pg_isready -U mlflow"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Para gitleaks
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ${{ matrix.project }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.in ]; then
            pip install -r requirements.in
          elif [ -f requirements.txt ]; then
            # Strip hashes to avoid --require-hashes errors with transitive deps
            grep -v '^[[:space:]]*--hash=' requirements.txt | \
            grep -v '^[[:space:]]*--require-hashes' | \
            sed 's/ \\$//' | \
            grep -v '^[[:space:]]*#' | \
            grep -v '^[[:space:]]*$' > requirements_no_hash.txt
            pip install -r requirements_no_hash.txt
          fi
          pip install pytest pytest-cov flake8 black isort mypy
      
      - name: Run linting
        working-directory: ${{ matrix.project }}
        run: |
          pip install flake8 black isort mypy
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
          black --check src/ || true
          isort --check-only src/ || true
      
      - name: Run tests with coverage
        working-directory: ${{ matrix.project }}
        run: |
          # Coverage thresholds: BankChurn 79%, CarVision 80%, TelecomAI 80%
          if [ "${{ matrix.project }}" = "BankChurn-Predictor" ]; then
            COV_TARGET="src"
            THRESHOLD=79
          elif [ "${{ matrix.project }}" = "CarVision-Market-Intelligence" ]; then
            COV_TARGET="src/carvision"
            THRESHOLD=80
          else
            COV_TARGET="src/telecom"
            THRESHOLD=80
          fi
          pytest --maxfail=1 --disable-warnings -q \
            -m "not slow" \
            --cov=$COV_TARGET --cov-report=xml --cov-report=term-missing \
            --cov-fail-under=$THRESHOLD
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ${{ matrix.project }}/coverage.xml
          flags: ${{ matrix.project }}
          name: ${{ matrix.project }}-coverage-${{ matrix.python-version }}
          fail_ci_if_error: false
      
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v5
        with:
          name: coverage-${{ matrix.project }}-py${{ matrix.python-version }}
          path: ${{ matrix.project }}/coverage.xml
          retention-days: 30
  
  # Job 2: Quality Gates - Enforce code quality standards
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [tests]
    if: always() && needs.tests.result != 'cancelled'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install quality tools
        run: pip install black flake8 coverage
      
      - name: Check Black formatting
        run: |
          echo "::group::Black Formatting Check"
          FAIL=0
          for project in BankChurn-Predictor CarVision-Market-Intelligence TelecomAI-Customer-Intelligence; do
            if [ -d "$project/src" ]; then
              black --check "$project/src" "$project/app" 2>/dev/null || FAIL=1
            fi
          done
          echo "::endgroup::"
          if [ "$FAIL" -eq 1 ]; then
            echo "::warning::Some files need formatting. Run 'black .' to fix."
          fi
      
      - name: Check Flake8 critical errors
        run: |
          echo "::group::Flake8 Critical Errors"
          for project in BankChurn-Predictor CarVision-Market-Intelligence TelecomAI-Customer-Intelligence; do
            if [ -d "$project/src" ]; then
              flake8 "$project/src" --count --select=E9,F63,F7,F82 --show-source --statistics
            fi
          done
          echo "::endgroup::"
      
      - name: Verify tests passed
        run: |
          if [ "${{ needs.tests.result }}" != "success" ]; then
            echo "::error::Tests did not pass. Quality gate failed."
            exit 1
          fi
          echo "‚úÖ All quality gates passed"
  
  # Job 3: Security scans
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true  # Don't fail on false positives
      
      - name: Install security tools
        run: pip install bandit pip-audit
      
      - name: Run Bandit security scan
        run: |
          mkdir -p reports
          bandit -r BankChurn-Predictor/src CarVision-Market-Intelligence/src TelecomAI-Customer-Intelligence/src \
            -f json -o reports/bandit-report.json -ll || true
          bandit -r . -f txt -ll || true
      
      - name: Run pip-audit dependency scan
        run: |
          pip-audit --format=json > reports/pip-audit-report.json || true
          pip-audit || true
      
      - name: Check for critical vulnerabilities
        run: |
          # Check Bandit for HIGH severity issues
          if [ -f reports/bandit-report.json ]; then
            HIGH=$(python3 -c "import json; d=json.load(open('reports/bandit-report.json')); print(d.get('metrics',{}).get('_totals',{}).get('SEVERITY.HIGH',0))" 2>/dev/null || echo 0)
            if [ "$HIGH" -gt 0 ]; then
              echo "::error::Critical security issues found in Bandit scan"
              exit 1
            fi
          fi
          echo "‚úÖ No critical security issues found"
      
      - name: Upload security reports
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: security-reports
          path: |
            reports/bandit-report.json
            reports/pip-audit-report.json
          retention-days: 30
  
  # Job 3: Docker builds & scans (with GitHub Actions cache)
  docker:
    name: Docker Build & Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - BankChurn-Predictor
          - CarVision-Market-Intelligence
          - TelecomAI-Customer-Intelligence
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image (with cache)
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.project }}
          file: ${{ matrix.project }}/Dockerfile
          push: false
          load: true
          tags: ml-portfolio:${{ matrix.project }}-${{ github.sha }}
          cache-from: type=gha,scope=${{ matrix.project }}
          cache-to: type=gha,mode=max,scope=${{ matrix.project }}
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ml-portfolio:${{ matrix.project }}-${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.project }}.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-results-${{ matrix.project }}.sarif'
  
  # Job 4: E2E Test (BankChurn)
  e2e:
    name: End-to-End Test
    runs-on: ubuntu-latest
    needs: [tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        working-directory: BankChurn-Predictor
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.in ]; then
            pip install -r requirements.in
          elif [ -f requirements.txt ]; then
            # Strip hashes to avoid --require-hashes errors with transitive deps
            grep -v '^[[:space:]]*--hash=' requirements.txt | \
            grep -v '^[[:space:]]*--require-hashes' | \
            sed 's/ \\$//' | \
            grep -v '^[[:space:]]*#' | \
            grep -v '^[[:space:]]*$' > requirements_no_hash.txt
            pip install -r requirements_no_hash.txt
          fi
      
      - name: Run E2E pipeline
        run: |
          chmod +x scripts/run_e2e.sh
          bash scripts/run_e2e.sh || true

  # Job 5: Cross-Project Integration Test (only on main or manual trigger)
  integration-test:
    name: Cross-Project Integration
    runs-on: ubuntu-latest
    needs: [docker]
    # Only run on: push to main, or manual workflow_dispatch
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && inputs.run_integration == true)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose
        run: |
          # Install docker-compose if not present (GitHub Actions runners usually have it)
          if ! command -v docker-compose &> /dev/null; then
             sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
             sudo chmod +x /usr/local/bin/docker-compose
          fi
      
      - name: Set up Python for model training
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      
      - name: Generate demo models
        run: |
          pip install scikit-learn pandas joblib numpy
          chmod +x scripts/setup_demo_models.sh
          bash scripts/setup_demo_models.sh
      - name: Build demo images for docker-compose (with cache)
        uses: docker/build-push-action@v5
        with:
          context: BankChurn-Predictor
          file: BankChurn-Predictor/Dockerfile
          push: false
          load: true
          tags: ml-portfolio-bankchurn:latest
          cache-from: type=gha,scope=BankChurn-Predictor
          cache-to: type=gha,mode=max,scope=BankChurn-Predictor
      
      - name: Build CarVision image (with cache)
        uses: docker/build-push-action@v5
        with:
          context: CarVision-Market-Intelligence
          file: CarVision-Market-Intelligence/Dockerfile
          push: false
          load: true
          tags: ml-portfolio-carvision:latest
          cache-from: type=gha,scope=CarVision-Market-Intelligence
          cache-to: type=gha,mode=max,scope=CarVision-Market-Intelligence
      
      - name: Build TelecomAI image (with cache)
        uses: docker/build-push-action@v5
        with:
          context: TelecomAI-Customer-Intelligence
          file: TelecomAI-Customer-Intelligence/Dockerfile
          push: false
          load: true
          tags: ml-portfolio-telecom:latest
          cache-from: type=gha,scope=TelecomAI-Customer-Intelligence
          cache-to: type=gha,mode=max,scope=TelecomAI-Customer-Intelligence
      
      - name: Spin up Demo Stack
        run: |
          # Start services using pre-built images
          docker-compose -f docker-compose.demo.yml up -d
          
          # Wait for services to be ready (increased for shap/heavy deps)
          echo "Waiting for services to initialize..."
          sleep 60
          
          # Show container status
          docker-compose -f docker-compose.demo.yml ps
          
          # Wait for health checks with retry logic
          echo "Waiting for health checks..."
          for service in bankchurn carvision telecom; do
            echo "Checking $service..."
            for i in {1..12}; do
              if docker-compose -f docker-compose.demo.yml exec -T $service curl -sf http://localhost:8000/health > /dev/null 2>&1; then
                echo "$service is healthy"
                break
              fi
              echo "  Attempt $i/12 - $service not ready, waiting 10s..."
              sleep 10
            done
          done
          
          # Final status
          docker-compose -f docker-compose.demo.yml ps
          echo "Recent logs:"
          docker-compose -f docker-compose.demo.yml logs --tail 30

      - name: Run Integration Tests
        run: |
          chmod +x scripts/run_demo_tests.sh
          bash scripts/run_demo_tests.sh
      
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Container Status ==="
          docker-compose -f docker-compose.demo.yml ps -a
          echo "=== CarVision Logs ==="
          docker-compose -f docker-compose.demo.yml logs carvision --tail 100
          echo "=== All Logs ==="
          docker-compose -f docker-compose.demo.yml logs --tail 50

      - name: Tear down
        if: always()
        run: docker-compose -f docker-compose.demo.yml down

  # Job 6: Integration report
  integration-report:
    name: Generate Integration Report
    runs-on: ubuntu-latest
    needs: [tests, quality-gates, security, docker]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate summary report
        run: |
          echo "# üìä CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Tests: ${{ needs.tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- üéØ Quality Gates: ${{ needs.quality-gates.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- üîí Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- üê≥ Docker: ${{ needs.docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  # Job 6: Model cards validation (opcional)
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for model cards
        run: |
          echo "Checking for model_card.md files..."
          find . -name "model_card.md" -type f
          
          # Verificar que existan en proyectos principales
          for project in BankChurn-Predictor CarVision-Market-Intelligence TelecomAI-Customer-Intelligence; do
            if [ ! -f "$project/model_card.md" ]; then
              echo "‚ö†Ô∏è  Missing model_card.md in $project"
            else
              echo "‚úÖ Found model_card.md in $project"
            fi
          done
      
      - name: Check data cards
        run: |
          echo "Checking for data_card.md files..."
          find . -name "data_card.md" -type f
      
      - name: Validate README files
        run: |
          echo "Checking README.md in all projects..."
          for dir in */; do
            if [ -d "$dir" ] && [ ! -f "${dir}README.md" ]; then
              echo "‚ö†Ô∏è  Missing README.md in $dir"
            fi
          done

  # Job 8: Build & Push Docker Images to GHCR (on main push only)
  ghcr-publish:
    name: Publish to GHCR
    needs: [tests, security, docker]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        project:
          - BankChurn-Predictor
          - CarVision-Market-Intelligence
          - TelecomAI-Customer-Intelligence
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ matrix.project }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.project }}
          file: ${{ matrix.project }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
