name: Retrain BankChurn Model

# Automated model retraining with MLflow Model Registry integration.
# Triggers:
#   - Manual dispatch with optional parameters
#   - Scheduled weekly retraining (disabled by default)
#
# Requirements:
#   - MLFLOW_TRACKING_URI secret (or uses local file:./mlruns)
#   - DVC configured for data versioning
#
# The workflow will:
#   1. Pull latest data via DVC
#   2. Train the model
#   3. Log metrics to MLflow
#   4. Register model if metrics meet threshold
#   5. Optionally promote to Production

on:
  workflow_dispatch:
    inputs:
      promote_to_production:
        description: "Promote model to Production if metrics pass"
        type: boolean
        default: false
      min_f1_score:
        description: "Minimum F1 score for promotion"
        type: string
        default: "0.60"
      min_auc:
        description: "Minimum AUC-ROC for promotion"
        type: string
        default: "0.80"
  # Uncomment for weekly scheduled retraining
  # schedule:
  #   - cron: '0 2 * * 0'

jobs:
  retrain:
    name: Retrain and Register Model
    runs-on: ubuntu-latest
    
    env:
      PROJECT_DIR: BankChurn-Predictor
      MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'file:./mlruns' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.in ]; then
            pip install -r requirements.in
          fi
          pip install mlflow dvc

      - name: Pull data with DVC
        working-directory: ${{ env.PROJECT_DIR }}
        continue-on-error: true
        run: |
          dvc pull || echo "DVC pull skipped (no remote configured)"

      - name: Train model
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          python main.py \
            --mode train \
            --config configs/config.yaml

      - name: Register and promote model
        working-directory: ${{ env.PROJECT_DIR }}
        env:
          MIN_F1: ${{ github.event.inputs.min_f1_score || '0.60' }}
          MIN_AUC: ${{ github.event.inputs.min_auc || '0.80' }}
          PROMOTE: ${{ github.event.inputs.promote_to_production || 'false' }}
        run: |
          python ../scripts/promote_model.py \
            --project bankchurn \
            --min-f1 $MIN_F1 \
            --min-auc $MIN_AUC \
            ${{ github.event.inputs.promote_to_production == 'true' && '--promote' || '' }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: bankchurn-model-${{ github.run_id }}
          path: |
            ${{ env.PROJECT_DIR }}/models/
            ${{ env.PROJECT_DIR }}/artifacts/
          retention-days: 30

  notify:
    name: Notify on completion
    runs-on: ubuntu-latest
    needs: retrain
    if: always()
    
    steps:
      - name: Report status
        run: |
          echo "## Retrain Job Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.retrain.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
