name: Retrain BankChurn

on:
  workflow_dispatch:
    inputs:
      data_version:
        description: "DVC data version (tag/commit) to pull before training (optional)"
        required: false
        default: ""

jobs:
  retrain:
    name: Retrain and promote BankChurn model
    runs-on: ubuntu-latest

    env:
      PROJECT_DIR: BankChurn-Predictor

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.in ]; then
            pip install -r requirements.in
          elif [ -f requirements.txt ]; then
            # Strip hashes to avoid --require-hashes errors with transitive deps
            grep -v '^[[:space:]]*--hash=' requirements.txt | \
            grep -v '^[[:space:]]*--require-hashes' | \
            sed 's/ \\$//' | \
            grep -v '^[[:space:]]*#' | \
            grep -v '^[[:space:]]*$' > requirements_no_hash.txt
            pip install -r requirements_no_hash.txt
          fi
          pip install mlflow dvc

      - name: Pull data with DVC
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          if [ -n "${{ github.event.inputs.data_version }}" ]; then
            dvc pull --rev "${{ github.event.inputs.data_version }}"
          else
            dvc pull
          fi

      - name: Train BankChurn model
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          python main.py \
            --mode train \
            --config configs/config.yaml \
            --input data/raw/Churn.csv \
            --model models/best_model.pkl \
            --preprocessor models/preprocessor.pkl

      - name: Log run to MLflow and promote to Staging
        working-directory: ${{ env.PROJECT_DIR }}
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_EXPERIMENT_NAME: BankChurn
          MLFLOW_REGISTERED_MODEL: BankChurnClassifier
          MLFLOW_TARGET_STAGE: Staging
          BC_MIN_F1: "0.80"
          BC_MIN_ROC_AUC: "0.85"
        run: |
          python scripts/run_mlflow.py
